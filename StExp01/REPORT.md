# 实验报告：路径可达性分析工具实现

## 一、实验目标
实现一个路径可达性分析工具，能够自动分析Java代码中的控制流路径，提取特定输出语句的可达条件，并评估这些条件的可满足性。具体要求：
1. 解析Java方法中的`if-else`结构，提取路径条件表达式。
2. 正确处理嵌套条件和逻辑运算符优先级。
3. 计算条件表达式的可达性结果（`true`或`false`）。


## 二、实现思路

### 1. 整体架构
基于`BaseDetector`类扩展`MyDetector`，重写两个核心方法：
- `getCondition(String pathFile, String methodName, String id)`：提取到达指定`System.out.println(id)`的条件表达式。
- `getReachability(String pathFile, String methodName, String id)`：评估条件表达式的可达性，返回`true` or `false`

所有的实现逻辑都在 `com.forDece.rechbot.MyDetector.java` 中

所有方法都写了 javadoc，关键逻辑写了注释

### 2. 条件表达式提取（getCondition）实现原理
1. **代码块深度追踪**：
    - 使用`currentDepth`记录当前嵌套层级。
    - 使用`blockDepths`栈记录每个条件对应的代码块深度，退出代码块时弹出对应条件。

2. **条件提取核心逻辑伪代码**：
   ```
    1. 初始化:
        - 条件栈 = [] // 存储路径上的条件表达式
        - 深度栈 = [] // 存储每个条件对应的代码块深度
        - 当前深度 = 0 // 初始为最外层代码块
    
    2. 遍历代码行:
        对方法代码的每一行:
            a. 预处理:
                - 去除行首尾空格
                - 跳过空行和无关行
                
            b. 检查终止条件:
                如果当前行是目标输出语句:
                    退出循环
                
            c. 更新代码块深度:
                如果行包含左大括号: 深度+1
                如果行包含右大括号: 深度-1，并弹出深度栈中>当前深度的元素
                
            d. 处理条件语句:
                如果行是if语句:
                    提取括号内的条件表达式
                    添加括号并压入条件栈
                    压入当前深度到深度栈
                
                如果行是else语句:
                    弹出条件栈顶元素
                    对条件取反
                    压入取反后的条件到条件栈
    
    3. 构建结果:
        返回条件栈中所有元素用"&&"连接的字符串
   ```

### 3. 判断路径是否可达（getReachability）实现原理

- 使用脚本引擎动态执行表达式并获取结果


## 三、遇到的问题与解决方案

### 1. 条件表达式括号问题
- **问题**：生成的条件表达式括号不匹配，导致逻辑错误。
- **解决方案**：
    - 始终为`if`条件添加括号。
    - 处理`else`分支时，移除最外层括号再取反。

### 2. 嵌套条件提取错误
- **问题**：错误收集无关条件，导致结果包含额外项。
- **解决方案**：
    - 引入代码块深度追踪，退出代码块时自动弹出条件。
    - 遇到目标行时立即停止收集，避免混入后续条件。

### 3. JavaScript引擎缺失
- **问题**：使用的 jdk 缺少JavaScript引擎，导致`NullPointerException`。
- **解决方案**：单独导入 JavaScript 引擎作为依赖


## 四、测试与验证

通过JUnit测试用例验证，所有测试均通过：
> ![img_3.png](assets/img_3.png)
